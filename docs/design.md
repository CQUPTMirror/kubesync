# kubesync 设计文档

本项目旨在在云原生环境中部署镜像站设施。

## 序

本项目包含三个模块：

- controller: 控制器，根据资源定义部署具体服务
- manager: 镜像管理器，与 API Server 交互，控制镜像任务的同步，为镜像任务、镜像站前端以及管理后台提供 REST API
- worker: 进行镜像同步

设计了四种 CRD：

- Announcement: 镜像站公告
- File: 便于用户下载文件所经过处理的文件信息
- Job: 镜像任务，包含多个容器
- Manager: 镜像管理器

系统整体架构图如下：

```
      +-------------------------------------------------------------------------+
      |                                 API Server                              |
      +---+--^------------------------------------------------+-^---------------+
          |  |                                 Resources Info | | Update Status
          |  |                     +--------------------------+-+---------------------------------------------------------------+
          |  |                     | Namespace #1             | |                                                               |
          |  |                     |                          | | Change Resources                                              |
          |  |                     |                     +----v-+----+                                                          |
          |  |                     |          +--------->|           +------------------------------------------------+         |
          |  |                     |   Update |          |  Manager  |                                                |         |
          |  |                     |   Status | +--------+           +--------------------------------+               |         |
          |  | Manage              |          | |Control +-----------+                                |               |         |
   Handle |  | Resources           |          | |Command                                              | Status        | REST    |
   CRDs   |  | (Deploy/CM/PVC/...) | +--------+-+---------------------------------------------+       | API           | API     |
(Manager/ |  |                     | | Job #1 | |                                             |       |               |         |
 Worker/  |  | Update              | | +------+-v-+ +----------------+ +--------------------+ | +-----v-------+ +-----v-------+ |
Announce/ |  | Deploy              | | |  Worker  | |  Rsync Server  | |  HTTP File Server  | | |  Home Page  | |  Dashboard  | |
 File)    |  | Status              | | +----------+ +--+-------------+ +-+-------------+----+ | +-----+-------+ +-----+-------+ |
          |  |                     | |                 |                 |             |      |       |               |         |
      +---v--+-------+             | +-----------------+-----------------+-------------+------+       |               |         |
      |  Controller  |             |                   |                 |             |              |               |         |
      +--------------+             +-------------------+-----------------+-------------+--------------+---------------+---------+
                                                       |                 | metrics     |              |               |
                                          +------------v--+    +---------v----+    +---v--------------v---------------v---------+
                                          |  Rsync Proxy  |    |  Prometheus  |<---+                   Ingress                  |
                                          +---------------+    +--------------+    +--------------------------------------------+
```

## 模块设计

### controller

controller 使用 Kubebuilder 搭建框架，通过调协实现了下面的几个功能：

1. Announcement
- 在 Announcement 内容发生变更时更新其状态中的创建、修改时间

2. Job
- 根据 Job 声明部署资源，如 PVC、Deployment、SVC、Ingress 等
- 获取并填充当前命名空间下可用的 Manager DNS 至 worker 容器环境变量

3. Manager
- 根据 Manager 声明部署资源，如 Service Account、RBAC、Deployment/DaemonSet、SVC、Ingress 等
- Manager 的资源访问权限被限制在其命名空间
- 一个命名空间下只允许存在一个可用 Manager

### manager

manager 通过 Operator SDK 与 API Server 通信，针对下面几种场景提供 REST API：

1. worker
- 为 worker 提供同步信息
- worker 上报同步状态及计划
- 下发控制指令给 worker
- worker 上报文件列表

2. front
- 提供镜像状态
- 提供镜像站通知
- 提供映像文件下载信息

3. dashboard
- 提供 Job 的增删改查
- 提供 Announcement 的增删改查
- 提供 File 的增删改查

### worker

worker 执行具体的镜像同步任务，相比 tunasync 的原版 worker 主要进行了以下改动：

1. 通过环境变量设置镜像任务
2. 删除多任务相关逻辑，但 worker 只执行一个镜像任务
